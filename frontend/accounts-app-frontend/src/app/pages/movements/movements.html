<div class="page-container">
  <div class="page-header">
    <h2 class="page-header__title">Movimientos</h2>
  </div>
  <div class="toolbar" *ngIf="!isModal">
    <div class="toolbar__search">
      <div class="account-filter">
        <div class="account-filter__header" (click)="onAccountFilterToggle()">
          <input 
            type="text" 
            [(ngModel)]="accountSearchTerm"
            (input)="filterAccounts()"
            placeholder="Buscar cuenta..."
            class="toolbar__input"
            readonly="readonly"
          />
          <button type="button" class="account-filter__toggle" title="Abrir filtro">
            <i [class]="accountFilterOpen ? 'fas fa-chevron-up' : 'fas fa-chevron-down'"></i>
          </button>
        </div>
        <div *ngIf="accountFilterOpen" class="account-filter__dropdown">
          <div class="account-filter__search">
            <input 
              type="text" 
              [(ngModel)]="accountSearchTerm"
              (input)="filterAccounts()"
              placeholder="Filtrar cuentas..."
              class="account-filter__input"
              autofocus
            />
          </div>
          <div class="account-filter__list">
            <div class="account-filter__item" (click)="onAccountSelected('')">
              <span>Todas las cuentas</span>
            </div>
            <div 
              *ngFor="let account of filteredAccounts" 
              class="account-filter__item"
              [class.account-filter__item--selected]="selectedAccountId === account.id"
              (click)="onAccountSelected(account.id!)"
            >
              <span>{{ account.accountNumber }} - {{ account.accountType }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn--primary" (click)="onNewMovement()">
      Nuevo
    </button>
  </div>

  <!-- Botón para crear movimiento en modal -->
  <div *ngIf="isModal" class="toolbar toolbar--modal">
    <button class="btn btn--primary" (click)="onNewMovement()">
      <i class="fas fa-plus"></i> Nuevo Movimiento
    </button>
  </div>
  <div class="table-container">
    <table class="data-table">
      <thead class="data-table__head">
        <tr class="data-table__head-row">
          <th class="data-table__header">Fecha</th>
          <th class="data-table__header">Descripción</th>
          <th class="data-table__header">Tipo</th>
          <th class="data-table__header">Monto</th>
          <th class="data-table__header">Saldo</th>
        </tr>
      </thead>
      <tbody>
        <tr class="data-table__body-row" *ngFor="let movement of movements$ | async">
          <td class="data-table__cell">{{ movement.date | date:'dd/MM/yyyy' }}</td>
          <td class="data-table__cell">{{ movement.description }}</td>
          <td class="data-table__cell">{{ movement.type }}</td>
          <td class="data-table__cell">{{ movement.amount | currency }}</td>
          <td class="data-table__cell">{{ movement.balance | currency }}</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="info-message">
    <p><i class="fas fa-info-circle"></i> Los movimientos no pueden ser editados o eliminados para mantener la integridad de los registros.</p>
  </div>
  <div class="pagination" *ngIf="!isModal">
    <button class="btn btn--secondary" (click)="onPreviousPage()" [disabled]="currentPage === 1">
      <i class="fas fa-minus"></i>
    </button>
    <span class="pagination__info">Página {{ currentPage }} de {{ totalPages }}</span>
    <button class="btn btn--secondary" (click)="onNextPage()" [disabled]="currentPage === totalPages">
      <i class="fas fa-plus"></i>
    </button>
  </div>

  <div *ngIf="showModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>{{ modalMode === 'create' ? 'Nuevo Movimiento' : 'Editar Movimiento' }}</h3>
      </div>
      <div class="modal-body">
        <!-- Información de saldo cuando es modal -->
        <div *ngIf="isModal && selectedAccount" class="account-info">
          <div class="account-info__item">
            <label>Cuenta:</label>
            <span class="account-info__value">{{ selectedAccount.accountNumber }} - {{ selectedAccount.accountType }}</span>
          </div>
          <div class="account-info__item">
            <label>Saldo Actual:</label>
            <span class="account-info__value account-info__balance">{{ selectedAccount.currentBalance | currency }}</span>
          </div>
        </div>
        <div class="form-group">
          <label>Descripción <span class="form-required">*</span></label>
          <input type="text" [(ngModel)]="formData.description" placeholder="Ej: Retiro de 575" class="form-input" required minlength="3" maxlength="200" />
          <small class="form-hint">Mínimo 3, máximo 200 caracteres</small>
        </div>
        <div class="form-group">
          <label>Tipo de Movimiento <span class="form-required">*</span></label>
          <select [(ngModel)]="formData.transactionType" class="form-input" required>
            <option value="">Seleccionar</option>
            <option value="CREDITO">Crédito</option>
            <option value="DEBITO">Débito</option>
          </select>
        </div>
        <div class="form-group">
          <label>Monto <span class="form-required">*</span></label>
          <input type="number" [(ngModel)]="formData.amount" placeholder="Ej: 500.00" class="form-input" required min="0.01" step="0.01" />
          <small class="form-hint">Monto debe ser mayor a 0</small>
        </div>
        <div class="form-group">
          <label>Cuenta <span class="form-required">*</span></label>
          <!-- Cuando es modal, mostrar solo lectura -->
          <div *ngIf="isModal" class="form-input form-input--readonly">
            {{ getSelectedAccountName() }}
          </div>
          <!-- Cuando es pantalla normal, mostrar select editable -->
          <select *ngIf="!isModal" [(ngModel)]="formData.accountId" class="form-input" required>
            <option value="">Seleccionar Cuenta</option>
            <option *ngFor="let account of allAccounts" [value]="account.id!">
              {{ account.accountNumber }} - {{ account.accountType }}
            </option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn--secondary" (click)="onCloseModal()">Cancelar</button>
        <button class="btn btn--primary" (click)="onSaveMovement()">Guardar</button>
      </div>
    </div>
  </div>
</div>
